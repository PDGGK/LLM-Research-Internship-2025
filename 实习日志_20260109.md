# 实习日志 - 2026年1月9日

## 今日工作概述

今天主要完成了 **SQL Researcher 的 Human-in-the-Loop (HITL) 问题拆解审核功能** 的开发和调试。这是一个让用户能够在系统自动拆解问题后进行人工审核和修改的功能。

## 主要工作内容

### 1. Human-in-the-Loop 功能设计与实现

**目标**：让用户能够审核和修改系统自动拆解的子问题，而不是直接执行。

**实现架构**：
```
用户输入问题
    ↓
decompose_question（分解问题）
    ↓
review_decomposition（人工审核）
    ↓
  用户确认?
   ↙    ↘
  是      否（提供反馈）
  ↓         ↓
继续执行   回到 decompose_question 重新分解
```

### 2. 遇到的问题与解决

#### 问题1：`interrupt()` 功能不工作
- **现象**：调用 `interrupt()` 后程序没有暂停
- **原因**：LangGraph 服务器没有加载最新代码
- **解决**：重启 `langgraph dev` 服务器

#### 问题2：用户反馈后无法重新分解
- **现象**：用户提供反馈后，系统重新分解但结果完全一样
- **原因**：最初我把 `interrupt` 放在 `decompose_question` 节点内部，导致 resume 后创建的是新 run，状态无法保留
- **解决**：参考 legacy 代码架构，将 `review_decomposition` 作为独立节点
  - `decompose_question` 读取 `decomposition_feedback` 状态进行分解
  - `review_decomposition` 使用 `interrupt` 获取用户反馈
  - 用户反馈后，通过 `Command(goto="decompose_question", update={"decomposition_feedback": [feedback]})` 回到分解节点

### 3. 代码修改

| 文件 | 修改内容 |
|------|----------|
| `sql_deep_researcher.py` | 1. 将 `decompose_question` 拆分为分解和审核两个节点 <br> 2. 新增 `review_decomposition` 节点处理人工审核 <br> 3. 更新图结构添加新节点 |
| `sql_state.py` | 将 `decomposition_feedback` 从 `Optional[str]` 改为 `Annotated[List[str], override_reducer]` |
| `sql_configuration.py` | 添加 `enable_decomposition_review` 配置项（默认 True） |

### 4. 测试结果

**测试案例**：用户输入复杂问题，包含客户数量、设备数量、上下线情况、down 状态设备等多个维度

| 阶段 | 结果 |
|------|------|
| 第一次拆解 | 7 个子问题 |
| 用户反馈 | "最多5个问题,down状态相关的可以合并" |
| 第二次拆解 | 4 个子问题 ✅ |
| 确认执行 | success ✅ |
| 最终报告 | 正确生成 ✅ |

## 技术收获

1. **LangGraph interrupt 机制**：
   - `interrupt()` 用于暂停图执行，等待外部输入
   - 必须配合 checkpointer 使用（`langgraph dev` 自动配置）
   - API 通过 `command: {resume: value}` 恢复执行

2. **状态管理最佳实践**：
   - 需要在多次节点调用间保持的数据应存储在状态中
   - 使用 `Annotated[List[T], override_reducer]` 可以覆盖默认的追加行为

3. **节点设计原则**：
   - 单一职责：分解和审核分开
   - 通过 `Command(goto=..., update={...})` 控制流转和状态更新

## 产出物

- **实现报告**：`FusionSQL/docs/20260109/hitl_implementation_report.md`
- **测试脚本**：`FusionSQL/docs/20260109/interactive_hitl_test.py`
- **核心代码修改**：`open_deep_research/src/sql_researcher/sql_deep_researcher.py`

## 明日计划

1. 进一步测试 HITL 功能的边界情况
2. 优化用户反馈的提示信息
3. 考虑添加最大修改次数限制
