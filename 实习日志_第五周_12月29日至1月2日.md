# 🚀 实习日志 | 第五周

> **实习时间**：2024年12月29日（周日）- 2025年1月2日（周四）
> **研究方向**：大规模 Schema 下的 Text-to-SQL 多表关联推理
> **指导方向**：AI 算法实习

---

## 📅 第五周工作概览

### 12月30日 周一 | Schema 枚举值增强 & 模型对比测试

**今日核心成果**

基于导师建议实施 Schema 枚举值增强，Qwen2.5-32B + Schema增强后 **Simple 题达到 100% 正确率**！并完成代码整理为独立模块。

---

#### 1. 模型对比测试（统一提示词）

发现之前的对比测试存在**提示词不一致**的问题，重新使用统一提示词进行 150 题测试：

| 模型 | 正确率 |
|:-----|:------:|
| Qwen2.5-32B | 80/150 (53.3%) |
| Qwen3 MoE | 94/150 (62.7%) |

**发现**: 告警类查询中，32B 经常误选 `event_sdn` 表而非正确的 `event_history` 表。

#### 2. 导师建议实施 - Schema 枚举值增强

**问题**: 模型无法从 Schema 描述中判断 "告警" 应该用哪个表

**解决方案**: 将枚举字段的 TOP10 值写入 Schema 描述

```
# 增强前
EVENT_NAME (varchar): 事件名称

# 增强后
EVENT_NAME (varchar): 事件名称。常见值: IP SLA State, Temperature State, Bgp peer state, Device state, CPU Utilization...
```

**增强的字段**:
- EVENT_NAME
- EVENT_TYPE_NAME
- EVENT_STATUS_NAME
- SEVERITY_NAME

#### 3. Schema 增强后效果验证

**7 题测试**:

| 测试 | 32B | MoE |
|:-----|:---:|:---:|
| 增强前 | 6/7 (85.7%) | 5.5/7 (78.6%) |
| 增强后 | **7/7 (100%)** | **7/7 (100%)** |

**150 题测试**:

| 难度 | 32B增强前 | 32B增强后 | 提升 |
|:-----|:--------:|:--------:|:----:|
| Simple | 36/50 (72%) | **50/50 (100%)** | +14 |
| Medium | 30/50 (60%) | 29/50 (58%) | -1 |
| Hard | 14/50 (28%) | 16/50 (32%) | +2 |
| **总计** | 80/150 (53.3%) | **95/150 (63.3%)** | **+15** |

**关键成果**: Qwen2.5-32B + Schema增强，**Simple 题达到 100% 正确率**！

#### 4. 检索成功率验证

确认 Schema 增强不影响检索效果：

| 测试 | 增强前 | 增强后 | 变化 |
|:-----|:------:|:------:|:----:|
| 300题 | 287/300 (95.7%) | 286/300 (95.3%) | -1 |

**结论**: 检索成功率保持稳定。

#### 5. 代码整理为独立模块

根据导师要求，将全链路代码整理为可独立运行的模块：

**新增文件**:
- `our_algorithm/__init__.py` - 包入口
- `our_algorithm/pipeline.py` - 统一 Pipeline 入口
- `our_algorithm/config.py` - 独立配置文件
- `our_algorithm/llm/qwen.py` - LLM 封装

**使用方法**:
```python
from our_algorithm import TextToSQL

pipeline = TextToSQL()
sql = pipeline.run("查询客户测试客户名下有多少设备")
```

---

#### 6. 产出文件

| 文件 | 说明 |
|:-----|:-----|
| `docs/milestone_20241230_qwen3_moe/150q_enhanced_full_review.md` | 150题人工审核报告 |
| `docs/milestone_20241230_qwen3_moe/150q_enhanced_schema_test.json` | 增强后测试数据 |
| `spider2_dev/schemas_table_level_enhanced/netcaredb_ai/event_history.json` | 增强后的 Schema |
| `our_algorithm/pipeline.py` | 统一 Pipeline 入口 |
| `our_algorithm/README.md` | 算法模块文档 |

---

#### 7. 核心结论

1. **Schema 枚举值增强有效**: 将枚举字段 TOP10 值写入 Schema，显著提升 SQL 正确率
2. **32B + Schema增强效果最佳**: Simple 题从 72% 提升到 100%
3. **代码已整理为独立模块**: `our_algorithm` 可作为独立包使用

#### 8. 下一步计划

| 优先级 | 任务 |
|-------|------|
| P0 | 继续优化 Medium/Hard 题的正确率 |
| P1 | 探索更多 Schema 增强策略 |
| P2 | 完成顶会论文研读（ACL、EMNLP 相关工作） |

---

*日志日期: 2024-12-30*
*核心成果: Schema 枚举值增强使 Simple 题正确率达到 100%，代码整理为独立模块*

